import requests
import json
from django.conf import settings
from typing import List, Dict, Optional
import re


class OpenRouterChatbotService:
    def __init__(self):
        self.api_key = "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"
        self.api_url = "https://openrouter.ai/api/v1/chat/completions"
        self.model = "anthropic/claude-3-haiku"  # Modelo gratuito de OpenRouter
        
        # Base de conocimiento por rol con funciones espec√≠ficas
        self.role_functions = {
            'IPS': {
                'name': 'IPS (Instituciones Prestadoras de Servicios de Salud)',
                'functions': {
                    'responder_glosas': {
                        'title': 'üìù Responder Glosas',
                        'description': 'C√≥mo responder glosas de manera efectiva',
                        'steps': [
                            '1. Ve a "Glosas" ‚Üí "Glosas Pendientes"',
                            '2. Busca la glosa que quieres responder',
                            '3. Haz clic en "Responder"',
                            '4. Completa el formulario con:',
                            '   ‚Ä¢ Respuesta detallada a la glosa',
                            '   ‚Ä¢ Documentos de soporte (opcional)',
                            '   ‚Ä¢ Justificaci√≥n t√©cnica',
                            '5. Haz clic en "Enviar Respuesta"'
                        ],
                        'tips': [
                            'S√© espec√≠fico y detallado en tu respuesta',
                            'Incluye referencias a normativas si aplica',
                            'Adjunta toda la documentaci√≥n de soporte disponible',
                            'Responde dentro del plazo establecido'
                        ]
                    },
                    'ver_estado_facturas': {
                        'title': 'üìä Ver Estado de Facturas',
                        'description': 'C√≥mo ver el estado actual de tus facturas',
                        'steps': [
                            '1. Ve a "Radicados" en el men√∫ principal',
                            '2. Ver√°s todas tus facturas con su estado actual',
                            '3. Los estados posibles son:',
                            '   ‚Ä¢ Radicada: Factura enviada a la ET',
                            '   ‚Ä¢ En Auditor√≠a: ET est√° revisando',
                            '   ‚Ä¢ Con Glosas: Tiene glosas pendientes',
                            '   ‚Ä¢ Aprobada: Factura aprobada para pago',
                            '   ‚Ä¢ Devuelta: Requiere correcciones'
                        ]
                    },
                    'subir_documentos': {
                        'title': 'üìé Subir Documentos de Soporte',
                        'description': 'C√≥mo adjuntar documentos a tus respuestas',
                        'steps': [
                            '1. Al responder una glosa, ver√°s la secci√≥n "Documentos"',
                            '2. Haz clic en "Seleccionar archivos"',
                            '3. Formatos aceptados: PDF, JPG, PNG',
                            '4. Tama√±o m√°ximo: 10MB por archivo',
                            '5. Puedes subir m√∫ltiples archivos',
                            '6. Haz clic en "Guardar" para adjuntarlos'
                        ]
                    },
                    'historial_glosas': {
                        'title': 'üìã Ver Historial de Glosas',
                        'description': 'C√≥mo acceder al historial completo de glosas',
                        'steps': [
                            '1. Ve a "Glosas" ‚Üí "Glosas Pendientes"',
                            '2. En cada glosa ver√°s un √≠cono de historial',
                            '3. Haz clic en el √≠cono para ver:',
                            '   ‚Ä¢ Fecha de creaci√≥n de la glosa',
                            '   ‚Ä¢ Respuestas enviadas',
                            '   ‚Ä¢ Decisiones de la ET',
                            '   ‚Ä¢ Documentos adjuntos',
                            '   ‚Ä¢ Cambios de estado'
                        ]
                    },
                    'manejar_devoluciones': {
                        'title': 'üîÑ Manejar Devoluciones',
                        'description': 'Qu√© hacer cuando una factura es devuelta',
                        'steps': [
                            '1. Ve a "Devoluciones" en el men√∫ principal',
                            '2. Revisa las razones de la devoluci√≥n',
                            '3. Corrige los errores identificados',
                            '4. Sube la factura corregida',
                            '5. Adjunta documentaci√≥n adicional si es necesario',
                            '6. Re-radica la factura corregida'
                        ]
                    }
                }
            },
            'ET': {
                'name': 'ET (Entidad Territorial)',
                'functions': {
                    'auditar_facturas': {
                        'title': 'üîç Auditar Facturas',
                        'description': 'C√≥mo realizar auditor√≠as efectivas',
                        'steps': [
                            '1. Ve a "Auditor√≠a" ‚Üí "Radicados"',
                            '2. Busca la factura que quieres auditar',
                            '3. Haz clic en "Auditar Factura"',
                            '4. Revisa todos los servicios facturados',
                            '5. Identifica items que requieren glosa',
                            '6. Crea glosas con justificaci√≥n t√©cnica'
                        ]
                    },
                    'crear_glosas': {
                        'title': 'üìù Crear Glosas',
                        'description': 'C√≥mo crear glosas con justificaci√≥n t√©cnica',
                        'steps': [
                            '1. En la auditor√≠a de factura, haz clic en "Crear Glosa"',
                            '2. Selecciona el tipo de glosa:',
                            '   ‚Ä¢ T√©cnica: Problemas con c√≥digos, descripciones',
                            '   ‚Ä¢ Administrativa: Documentaci√≥n faltante',
                            '   ‚Ä¢ Econ√≥mica: Valores no autorizados',
                            '3. Completa la justificaci√≥n detallada',
                            '4. Adjunta documentos de soporte si es necesario',
                            '5. Haz clic en "Guardar Glosa"'
                        ]
                    },
                    'decidir_respuestas': {
                        'title': '‚öñÔ∏è Decidir sobre Respuestas de IPS',
                        'description': 'C√≥mo evaluar respuestas de IPS a glosas',
                        'steps': [
                            '1. Ve a "Auditor√≠a" ‚Üí "Glosas Pendientes"',
                            '2. Busca glosas con respuestas de IPS',
                            '3. Revisa la respuesta y documentaci√≥n',
                            '4. Eval√∫a si la justificaci√≥n es v√°lida',
                            '5. Toma decisi√≥n: Aceptar o Rechazar',
                            '6. Agrega comentarios si es necesario'
                        ]
                    },
                    'generar_reportes': {
                        'title': 'üìä Generar Reportes',
                        'description': 'C√≥mo crear reportes de auditor√≠a',
                        'steps': [
                            '1. Ve a "Reportes" en el men√∫ principal',
                            '2. Selecciona el tipo de reporte:',
                            '   ‚Ä¢ Reporte de Auditor√≠a por Lote',
                            '   ‚Ä¢ Reporte de Auditor√≠a Detalle',
                            '   ‚Ä¢ Reporte de Glosas',
                            '3. Configura los filtros de fecha y entidad',
                            '4. Haz clic en "Generar Reporte"',
                            '5. Descarga el reporte en PDF'
                        ]
                    },
                    'devolver_facturas': {
                        'title': 'üîÑ Devolver Facturas',
                        'description': 'Cu√°ndo y c√≥mo devolver facturas',
                        'steps': [
                            '1. En la auditor√≠a, identifica errores cr√≠ticos',
                            '2. Errores que justifican devoluci√≥n:',
                            '   ‚Ä¢ Documentaci√≥n faltante esencial',
                            '   ‚Ä¢ Errores en datos del paciente',
                            '   ‚Ä¢ Servicios no autorizados',
                            '3. Haz clic en "Devolver Factura"',
                            '4. Especifica las razones de devoluci√≥n',
                            '5. La IPS recibir√° notificaci√≥n'
                        ]
                    }
                }
            },
            'AUDITOR': {
                'name': 'Auditor',
                'functions': {
                    'realizar_auditoria': {
                        'title': 'üîç Realizar Auditor√≠a Completa',
                        'description': 'Proceso completo de auditor√≠a',
                        'steps': [
                            '1. Ve a "Auditor√≠a" ‚Üí "Radicados"',
                            '2. Selecciona la factura a auditar',
                            '3. Revisa exhaustivamente:',
                            '   ‚Ä¢ Datos del paciente',
                            '   ‚Ä¢ Servicios facturados',
                            '   ‚Ä¢ Documentaci√≥n de soporte',
                            '   ‚Ä¢ Valores y c√≥digos',
                            '4. Crea glosas seg√∫n hallazgos',
                            '5. Documenta todos los hallazgos'
                        ]
                    },
                    'revisar_glosas': {
                        'title': 'üìã Revisar Glosas y Respuestas',
                        'description': 'C√≥mo revisar glosas existentes',
                        'steps': [
                            '1. Ve a "Auditor√≠a" ‚Üí "Glosas Pendientes"',
                            '2. Revisa glosas creadas por otros auditores',
                            '3. Analiza respuestas de IPS',
                            '4. Verifica documentaci√≥n adjunta',
                            '5. Toma decisiones informadas',
                            '6. Documenta justificaciones'
                        ]
                    },
                    'generar_reportes_detallados': {
                        'title': 'üìä Generar Reportes Detallados',
                        'description': 'Reportes especializados de auditor√≠a',
                        'steps': [
                            '1. Ve a "Reportes" ‚Üí "Reporte de Auditor√≠a Detalle"',
                            '2. Selecciona factura espec√≠fica',
                            '3. El reporte incluye:',
                            '   ‚Ä¢ Resumen ejecutivo',
                            '   ‚Ä¢ Detalle de glosas por tipo',
                            '   ‚Ä¢ Historial completo de cambios',
                            '   ‚Ä¢ Documentos adjuntos',
                            '   ‚Ä¢ Decisiones tomadas'
                        ]
                    },
                    'analizar_historial': {
                        'title': 'üìà Analizar Historial de Cambios',
                        'description': 'C√≥mo interpretar el historial de glosas',
                        'steps': [
                            '1. En cualquier glosa, haz clic en el √≠cono de historial',
                            '2. Revisa cronol√≥gicamente:',
                            '   ‚Ä¢ Fecha de creaci√≥n',
                            '   ‚Ä¢ Modificaciones realizadas',
                            '   ‚Ä¢ Respuestas de IPS',
                            '   ‚Ä¢ Decisiones tomadas',
                            '   ‚Ä¢ Documentos agregados'
                        ]
                    },
                    'finalizar_auditoria': {
                        'title': '‚úÖ Finalizar Auditor√≠a',
                        'description': 'C√≥mo cerrar una auditor√≠a correctamente',
                        'steps': [
                            '1. Verifica que todas las glosas tengan decisi√≥n',
                            '2. Revisa que la documentaci√≥n est√© completa',
                            '3. Genera reporte final de auditor√≠a',
                            '4. Haz clic en "Finalizar Auditor√≠a"',
                            '5. Confirma que todos los datos est√©n correctos',
                            '6. La factura pasa al siguiente estado'
                        ]
                    }
                }
            },
            'EPS': {
                'name': 'EPS (Entidades Promotoras de Salud)',
                'functions': {
                    'revisar_facturas': {
                        'title': 'üìã Revisar Estado de Facturas',
                        'description': 'C√≥mo ver el estado de tus facturas',
                        'steps': [
                            '1. Ve a "Radicados" en el men√∫ principal',
                            '2. Filtra por tu EPS',
                            '3. Estados disponibles:',
                            '   ‚Ä¢ Radicada: Enviada a ET',
                            '   ‚Ä¢ En Auditor√≠a: En revisi√≥n',
                            '   ‚Ä¢ Con Glosas: Tiene observaciones',
                            '   ‚Ä¢ Aprobada: Lista para pago',
                            '   ‚Ä¢ Devuelta: Requiere correcci√≥n'
                        ]
                    },
                    'ver_resultados_auditoria': {
                        'title': 'üìä Ver Resultados de Auditor√≠a',
                        'description': 'C√≥mo interpretar resultados de auditor√≠a',
                        'steps': [
                            '1. Ve a "Reportes" ‚Üí "Reporte de Auditor√≠a"',
                            '2. Selecciona factura espec√≠fica',
                            '3. Revisa:',
                            '   ‚Ä¢ Total facturado vs aprobado',
                            '   ‚Ä¢ Glosas aplicadas',
                            '   ‚Ä¢ Justificaciones de la ET',
                            '   ‚Ä¢ Documentos de soporte',
                            '4. Calcula el valor a pagar'
                        ]
                    },
                    'acceder_reportes': {
                        'title': 'üìà Acceder a Reportes',
                        'description': 'Reportes disponibles para EPS',
                        'steps': [
                            '1. Ve a "Reportes" en el men√∫ principal',
                            '2. Reportes disponibles:',
                            '   ‚Ä¢ Reporte de Auditor√≠a por Lote',
                            '   ‚Ä¢ Reporte de Auditor√≠a Detalle',
                            '   ‚Ä¢ Reporte de Glosas',
                            '   ‚Ä¢ Reporte de Cartera',
                            '3. Configura filtros de fecha y entidad',
                            '4. Descarga en formato PDF'
                        ]
                    },
                    'interpretar_glosas': {
                        'title': 'üîç Interpretar Glosas',
                        'description': 'C√≥mo entender las glosas aplicadas',
                        'steps': [
                            '1. En el reporte de auditor√≠a, revisa la secci√≥n de glosas',
                            '2. Tipos de glosas:',
                            '   ‚Ä¢ T√©cnica: Problemas con c√≥digos o descripciones',
                            '   ‚Ä¢ Administrativa: Documentaci√≥n faltante',
                            '   ‚Ä¢ Econ√≥mica: Valores no autorizados',
                            '3. Revisa justificaciones de la ET',
                            '4. Analiza impacto en el pago'
                        ]
                    },
                    'gestionar_cartera': {
                        'title': 'üí∞ Gestionar Cartera',
                        'description': 'C√≥mo calcular y gestionar tu cartera',
                        'steps': [
                            '1. Ve a "Cartera" en el men√∫ principal',
                            '2. Revisa totales:',
                            '   ‚Ä¢ Valor inicial de facturas',
                            '   ‚Ä¢ Glosas provisionales',
                            '   ‚Ä¢ Glosas definitivas',
                            '   ‚Ä¢ Valor pagable final',
                            '3. Analiza tendencias por IPS',
                            '4. Proyecta pagos futuros'
                        ]
                    }
                }
            }
        }

    def is_greeting(self, message: str) -> bool:
        """Detecta si el mensaje es un saludo"""
        greetings = [
            'hola', 'buenos d√≠as', 'buenas tardes', 'buenas noches', 'saludos',
            'hey', 'hi', 'hello', 'buen d√≠a', 'qu√© tal', 'como est√°s',
            'ayuda', 'ay√∫dame', 'necesito ayuda', 'qu√© puedes hacer',
            'funciones', 'opciones', 'men√∫', 'qu√© haces'
        ]
        
        message_lower = message.lower().strip()
        return any(greeting in message_lower for greeting in greetings)

    def get_function_menu(self, role: str) -> str:
        """Genera el men√∫ de funciones espec√≠ficas para el rol"""
        if role not in self.role_functions:
            return "Lo siento, no tengo informaci√≥n espec√≠fica para tu rol."
        
        role_info = self.role_functions[role]
        menu = f"""üéØ **Men√∫ de Funciones para {role_info['name']}**

Aqu√≠ tienes las funciones principales que puedo explicarte:

"""
        
        for key, function in role_info['functions'].items():
            menu += f"**{function['title']}**\n"
            menu += f"_{function['description']}_\n\n"
        
        menu += """**¬øQu√© funci√≥n te gustar√≠a que te explique en detalle?**

Escribe el n√∫mero o el nombre de la funci√≥n que te interesa:
"""
        
        # Agregar opciones numeradas
        for i, (key, function) in enumerate(role_info['functions'].items(), 1):
            menu += f"{i}. {function['title']}\n"
        
        return menu

    def get_function_details(self, role: str, function_key: str) -> str:
        """Obtiene los detalles completos de una funci√≥n espec√≠fica"""
        if role not in self.role_functions:
            return "Lo siento, no tengo informaci√≥n para tu rol."
        
        if function_key not in self.role_functions[role]['functions']:
            return "Lo siento, no encontr√© esa funci√≥n espec√≠fica."
        
        function = self.role_functions[role]['functions'][function_key]
        
        details = f"""# {function['title']}

{function['description']}

## üìã Pasos a seguir:

"""
        
        for step in function['steps']:
            details += f"{step}\n"
        
        if 'tips' in function:
            details += "\n## üí° Consejos importantes:\n\n"
            for tip in function['tips']:
                details += f"‚Ä¢ {tip}\n"
        
        details += f"""

---
¬øTe gustar√≠a que te explique otra funci√≥n o tienes alguna pregunta espec√≠fica sobre {function['title']}?"""
        
        return details

    def get_response(self, message: str, role: str, conversation_history: Optional[List[Dict]] = None) -> str:
        """
        Genera una respuesta basada en el rol del usuario y el mensaje
        """
        message_lower = message.lower().strip()
        
        # Detectar si es un saludo
        if self.is_greeting(message):
            return self.get_function_menu(role)
        
        # Detectar si est√° pidiendo una funci√≥n espec√≠fica
        if role in self.role_functions:
            role_info = self.role_functions[role]
            
            # Buscar funci√≥n por n√∫mero
            if message_lower.isdigit():
                num = int(message_lower)
                if 1 <= num <= len(role_info['functions']):
                    function_key = list(role_info['functions'].keys())[num - 1]
                    return self.get_function_details(role, function_key)
            
            # Buscar funci√≥n por nombre
            for key, function in role_info['functions'].items():
                function_words = function['title'].lower().split()
                if any(word in message_lower for word in function_words):
                    return self.get_function_details(role, key)
        
        # Respuesta gen√©rica si no se reconoce
        return f"""No entiendo exactamente qu√© necesitas. 

Como {self.role_functions.get(role, {}).get('name', 'usuario')}, puedo ayudarte con las funciones del sistema.

Escribe "hola" o "ayuda" para ver el men√∫ completo de funciones disponibles para tu rol."""

    def get_welcome_message(self, role: str) -> str:
        """Genera un mensaje de bienvenida personalizado seg√∫n el rol"""
        if role not in self.role_functions:
            return "¬°Hola! üëã Soy tu asistente virtual para el sistema de auditor√≠a de cuentas m√©dicas. ¬øEn qu√© puedo ayudarte hoy?"
        
        role_info = self.role_functions[role]
        
        return f"""¬°Hola! üëã Soy tu asistente virtual especializado en el sistema de auditor√≠a de cuentas m√©dicas.

Como **{role_info['name']}**, puedo ayudarte con todas las funciones del sistema.

**¬øQu√© te gustar√≠a hacer hoy?**

Escribe "hola" o "ayuda" para ver el men√∫ completo de funciones disponibles para tu rol, o preg√∫ntame directamente sobre cualquier proceso que necesites."""


# Instancia global del servicio
chatbot_service = OpenRouterChatbotService() 