{% extends 'base.html' %}
{% block title %}Reporte de Auditoría - Factura {{ factura.numero }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Reporte de Auditoría - Factura #{{ factura.numero }}</h2>
        <button class="btn btn-secondary" onclick="window.print()"><i class="bi bi-printer"></i> Imprimir Reporte</button>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Detalles de la Factura</h5>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-4">Número de Factura:</dt>
                <dd class="col-sm-8">{{ factura.numero }}</dd>

                <dt class="col-sm-4">CUFE:</dt>
                <dd class="col-sm-8">{{ factura.cufe }}</dd>

                <dt class="col-sm-4">IPS:</dt>
                <dd class="col-sm-8">{{ factura.ips.entidad_nombre|default:"N/A" }}</dd>

                <dt class="col-sm-4">EPS:</dt>
                <dd class="col-sm-8">{{ factura.eps.entidad_nombre|default:"N/A" }}</dd>

                <dt class="col-sm-4">Valor Bruto:</dt>
                <dd class="col-sm-8">${{ factura.valor_bruto|floatformat:2 }}</dd>

                <dt class="col-sm-4">Fecha Radicación:</dt>
                <dd class="col-sm-8">{{ factura.fecha_radicacion|date:"Y-m-d" }}</dd>

                <dt class="col-sm-4">Estado de Auditoría:</dt>
                <dd class="col-sm-8">{{ factura.get_estado_display }}</dd>

                <dt class="col-sm-4">Auditor Asignado:</dt>
                <dd class="col-sm-8">{% if factura.auditor %}{{ factura.auditor.get_full_name|default:factura.auditor.username }}{% else %}N/A{% endif %}</dd>

                <dt class="col-sm-4">Tipo de Auditoría:</dt>
                <dd class="col-sm-8">{{ factura.get_tipo_auditoria_display|default:"N/A" }}</dd>

                <dt class="col-sm-4">Valor Glosado Definitivo:</dt>
                <dd class="col-sm-8">${{ valor_total_glosado_definitivo|floatformat:2 }}</dd>

                <dt class="col-sm-4">Valor Neto a Pagar:</dt>
                <dd class="col-sm-8">${{ valor_neto_a_pagar|floatformat:2 }}</dd>
            </dl>
        </div>
    </div>

    {% if factura.archivo_pdf %}
    <div class="mb-3">
        <label><strong>Factura PDF:</strong></label>
        <a href="{{ factura.archivo_pdf.url }}" target="_blank" class="btn btn-outline-primary btn-sm">Ver/Descargar PDF</a>
        <br>
        <embed src="{{ factura.archivo_pdf.url }}" type="application/pdf" width="100%" height="500px"/>
    </div>
    {% else %}
    <p class="text-muted">No se ha subido el PDF de la factura.</p>
    {% endif %}

    {% if factura.estado == 'Devuelta' and factura.devolucion %}
    <div class="card shadow-sm mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-arrow-return-left"></i> Información de la Devolución</h5>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-4">Fecha Devolución:</dt>
                <dd class="col-sm-8">{{ factura.devolucion.fecha_devolucion|date:"Y-m-d H:i" }}</dd>

                <dt class="col-sm-4">Código General:</dt>
                <dd class="col-sm-8">{{ factura.devolucion.subcodigo.codigo_padre.codigo }} - {{ factura.devolucion.subcodigo.codigo_padre.descripcion }}</dd>

                <dt class="col-sm-4">Código Específico:</dt>
                <dd class="col-sm-8">{{ factura.devolucion.subcodigo.subcodigo }} - {{ factura.devolucion.subcodigo.descripcion }}</dd>
                
                <dt class="col-sm-4">Justificación Adicional:</dt>
                <dd class="col-sm-8">{{ factura.devolucion.justificacion|default:"No se proporcionó justificación adicional." }}</dd>

                <dt class="col-sm-4">Devuelto Por:</dt>
                <dd class="col-sm-8">{% if factura.devolucion and factura.devolucion.devuelto_por %}{{ factura.devolucion.devuelto_por.get_full_name|default:factura.devolucion.devuelto_por.username }}{% else %}Sistema (Automático){% endif %}</dd>
            </dl>
        </div>
    </div>
    {% endif %}

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Información del Paciente</h5>
        </div>
        <div class="card-body">
            {% if paciente %}
            <dl class="row mb-0">
                <dt class="col-sm-4">Tipo Documento:</dt>
                <dd class="col-sm-8">{{ paciente.tipo_documento|default:"N/A" }}</dd>

                <dt class="col-sm-4">Número Documento:</dt>
                <dd class="col-sm-8">{{ paciente.numero_documento|default:"N/A" }}</dd>

                <dt class="col-sm-4">Tipo Usuario:</dt>
                <dd class="col-sm-8">{{ paciente.tipo_usuario|default:"N/A" }}</dd>

                <dt class="col-sm-4">Fecha Nacimiento:</dt>
                <dd class="col-sm-8">{{ paciente.fecha_nacimiento|date:"Y-m-d"|default:"N/A" }}</dd>

                <dt class="col-sm-4">Sexo:</dt>
                <dd class="col-sm-8">{{ paciente.sexo|default:"N/A" }}</dd>

                <dt class="col-sm-4">País Residencia:</dt>
                <dd class="col-sm-8">{{ paciente.pais_residencia|default:"N/A" }}</dd>

                <dt class="col-sm-4">Municipio Residencia:</dt>
                <dd class="col-sm-8">{{ paciente.municipio_residencia|default:"N/A" }}</dd>

                <dt class="col-sm-4">Zona Territorial:</dt>
                <dd class="col-sm-8">{{ paciente.zona_territorial|default:"N/A" }}</dd>

                <dt class="col-sm-4">Incapacidad:</dt>
                <dd class="col-sm-8">{{ paciente.incapacidad|default:"N/A" }}</dd>

                <dt class="col-sm-4">País Origen:</dt>
                <dd class="col-sm-8">{{ paciente.pais_origen|default:"N/A" }}</dd>
            </dl>
            {% else %}
            <p class="text-muted">No hay información de paciente asociada a esta factura.</p>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">Seguimiento Completo de Glosas</h5>
        </div>
        <div class="card-body">
            {% if glosas %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle table-sm">
                    <thead class="table-light">
                        <tr>
                            <th rowspan="2">Fecha Glosa</th>
                            <th rowspan="2">Tipo Glosa</th>
                            <th rowspan="2">Descripción Glosa</th>
                            <th rowspan="2">Valor Glosado</th>
                            <th rowspan="2">Estado Actual</th>
                            <th colspan="4" class="text-center">Respuesta de la IPS</th>
                            <th colspan="4" class="text-center">Decisión de la ET/Auditor</th>
                            <th rowspan="2">Historial</th>
                        </tr>
                        <tr>
                            <th>Fecha Respuesta</th>
                            <th>IPS Aceptó</th>
                            <th>Descripción Respuesta</th>
                            <th>Soporte</th>
                            <th>Fecha Decisión</th>
                            <th>Decisión ET</th>
                            <th>Valor Aceptado ET</th>
                            <th>Justificación ET</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for glosa in glosas %}
                        <tr>
                            <td>{{ glosa.fecha_glosa|date:"Y-m-d" }}</td>
                            <td>
                                {% if glosa.tipo_glosa %}
                                    <strong>{{ glosa.tipo_glosa.codigo }}</strong><br>
                                    <small>{{ glosa.tipo_glosa.nombre }}</small>
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>{{ glosa.descripcion|default:"N/A" }}</td>
                            <td>${{ glosa.valor_glosado|floatformat:2 }}</td>
                            <td>
                                {% if glosa.estado == 'Pendiente' %}
                                    <span class="badge bg-warning">{{ glosa.get_estado_display }}</span>
                                {% elif glosa.estado == 'Respondida IPS' %}
                                    <span class="badge bg-info">{{ glosa.get_estado_display }}</span>
                                {% elif glosa.estado == 'Aceptada ET' %}
                                    <span class="badge bg-success">{{ glosa.get_estado_display }}</span>
                                {% elif glosa.estado == 'Rechazada ET' %}
                                    <span class="badge bg-danger">{{ glosa.get_estado_display }}</span>
                                {% elif glosa.estado == 'Devuelta a IPS' %}
                                    <span class="badge bg-secondary">{{ glosa.get_estado_display }}</span>
                                {% else %}
                                    <span class="badge bg-primary">{{ glosa.get_estado_display }}</span>
                                {% endif %}
                            </td>
                            <!-- Respuesta de la IPS -->
                            <td>{{ glosa.fecha_respuesta|date:"Y-m-d"|default:"N/A" }}</td>
                            <td>
                                {% if glosa.aceptada == True %}
                                    <span class="badge bg-success">Sí</span>
                                {% elif glosa.aceptada == False %}
                                    <span class="badge bg-danger">No</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if glosa.descripcion_respuesta %}
                                    {{ glosa.descripcion_respuesta|truncatechars:50 }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if glosa.archivo_soporte_respuesta %}
                                    <a href="{{ glosa.archivo_soporte_respuesta.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-file-earmark-text"></i> Ver
                                    </a>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <!-- Decisión de la ET/Auditor -->
                            <td>{{ glosa.fecha_decision_et|date:"Y-m-d"|default:"N/A" }}</td>
                            <td>
                                {% if glosa.estado == 'Aceptada ET' %}
                                    <span class="badge bg-success">Aceptada</span>
                                {% elif glosa.estado == 'Rechazada ET' %}
                                    <span class="badge bg-danger">Rechazada</span>
                                {% elif glosa.estado == 'Devuelta a IPS' %}
                                    <span class="badge bg-warning">Devuelta</span>
                                {% else %}
                                    <span class="text-muted">Pendiente</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if glosa.valor_aceptado_et is not None %}
                                    ${{ glosa.valor_aceptado_et|floatformat:2 }}
                                    {% if glosa.valor_aceptado_et == 0 %}
                                        <br><small class="text-success">Glosa Levantada</small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if glosa.decision_et_justificacion %}
                                    {{ glosa.decision_et_justificacion|truncatechars:50 }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <!-- Historial de la Glosa -->
                            <td>
                                {% if glosa.historial.all %}
                                    <div class="dropdown">
                                        <button class="btn btn-outline-info btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-clock-history"></i> {{ glosa.historial.count }}
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" style="min-width: 350px; max-width: 450px;">
                                            <li class="dropdown-header">
                                                <strong>Historial de Glosa #{{ glosa.id }}</strong>
                                            </li>
                                            <li><hr class="dropdown-divider"></li>
                                            {% for registro in glosa.historial.all|slice:":8" %}
                                                <li class="dropdown-item py-2">
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <div class="d-flex justify-content-between align-items-start mb-1">
                                                                <small class="text-muted">{{ registro.fecha_cambio|date:"d/m/Y H:i" }}</small>
                                                                <span class="badge bg-secondary">{{ registro.get_accion_display }}</span>
                                                            </div>
                                                            {% if registro.usuario %}
                                                                <div class="mb-1">
                                                                    <small><i class="bi bi-person"></i> {{ registro.usuario.get_full_name|default:registro.usuario.username }}</small>
                                                                </div>
                                                            {% else %}
                                                                <div class="mb-1">
                                                                    <small><i class="bi bi-person"></i> <span class="text-muted">Sistema</span></small>
                                                                </div>
                                                            {% endif %}
                                                            {% if registro.estado_anterior and registro.estado_nuevo %}
                                                                <div class="mb-1">
                                                                    <small class="badge bg-light text-dark">{{ registro.estado_anterior }}</small>
                                                                    <i class="bi bi-arrow-right text-muted"></i>
                                                                    <small class="badge bg-primary">{{ registro.estado_nuevo }}</small>
                                                                </div>
                                                            {% endif %}
                                                            {% if registro.descripcion_cambio %}
                                                                <div class="mb-1">
                                                                    <small class="text-muted">{{ registro.descripcion_cambio|truncatechars:80 }}</small>
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </li>
                                                {% if not forloop.last %}
                                                    <li><hr class="dropdown-divider"></li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if glosa.historial.count > 8 %}
                                                <li class="dropdown-item text-center py-2">
                                                    <small class="text-muted">... y {{ glosa.historial.count|add:"-8" }} registros más</small>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                            {% endif %}
                                            <li class="dropdown-item text-center py-2">
                                                <a href="{% url 'auditoria:historial_glosa' glosa.id %}" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-arrow-right"></i> Ver Historial Completo
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                {% else %}
                                    <span class="text-muted">Sin historial</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Resumen de Estados -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <h6>Resumen por Estado:</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Pendientes
                            <span class="badge bg-warning rounded-pill">{{ glosas|dictsort:"estado"|length }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Respondidas por IPS
                            <span class="badge bg-info rounded-pill">{{ glosas|dictsort:"estado"|length }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Aceptadas por ET
                            <span class="badge bg-success rounded-pill">{{ glosas|dictsort:"estado"|length }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Rechazadas por ET
                            <span class="badge bg-danger rounded-pill">{{ glosas|dictsort:"estado"|length }}</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>Resumen Financiero:</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Valor Total Glosado Original
                            <span class="text-primary">${{ factura.valor_bruto|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Valor Definitivo Glosado
                            <span class="text-success">${{ valor_total_glosado_definitivo|floatformat:2 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Valor Neto a Pagar
                            <span class="text-info">${{ valor_neto_a_pagar|floatformat:2 }}</span>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>Resumen del Historial:</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Total Registros Historial
                            <span class="badge bg-info rounded-pill">{{ total_historial }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Glosas con Historial
                            <span class="badge bg-success rounded-pill">{{ glosas_con_historial }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Última Actividad
                            <span class="text-muted">
                                {% if ultima_actividad %}
                                    {{ ultima_actividad|date:"d/m/Y" }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </li>
                    </ul>
                </div>
            </div>
            {% else %}
            <p class="text-muted">No hay glosas registradas para esta factura.</p>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Ítems RIPS Asociados</h5>
        </div>
        <div class="card-body">
            {# Consultas #}
            {% if rips_consultas %}
            <h6>Consultas</h6>
            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Consecutivo</th>
                            <th>Fecha Inicio</th>
                            <th>Cód. Consulta</th>
                            <th>Diagnóstico Ppal.</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in rips_consultas %}
                        <tr>
                            <td>{{ item.consecutivo }}</td>
                            <td>{{ item.fecha_inicio_atencion|date:"Y-m-d H:i" }}</td>
                            <td>{{ item.cod_consulta }}</td>
                            <td>{{ item.cod_diagnostico_principal }}</td>
                            <td>${{ item.vr_servicio|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No hay consultas RIPS.</p>
            {% endif %}

            {# Medicamentos #}
            {% if rips_medicamentos %}
            <h6>Medicamentos</h6>
            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Consecutivo</th>
                            <th>Fecha Dispensación</th>
                            <th>Cód. Tecnología</th>
                            <th>Nombre Tecnología</th>
                            <th>Cantidad</th>
                            <th>Valor Unit.</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in rips_medicamentos %}
                        <tr>
                            <td>{{ item.consecutivo }}</td>
                            <td>{{ item.fecha_dispensacion|date:"Y-m-d H:i" }}</td>
                            <td>{{ item.cod_tecnologia_salud }}</td>
                            <td>{{ item.nom_tecnologia_salud }}</td>
                            <td>{{ item.cantidad_medicamento }} {{ item.unidad_medida }}</td>
                            <td>${{ item.vr_unit_medicamento|floatformat:2 }}</td>
                            <td>${{ item.vr_servicio|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No hay medicamentos RIPS.</p>
            {% endif %}

            {# Procedimientos #}
            {% if rips_procedimientos %}
            <h6>Procedimientos</h6>
            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Consecutivo</th>
                            <th>Fecha Inicio</th>
                            <th>Cód. Procedimiento</th>
                            <th>Diagnóstico Ppal.</th>
                            <th>Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in rips_procedimientos %}
                        <tr>
                            <td>{{ item.consecutivo }}</td>
                            <td>{{ item.fecha_inicio_atencion|date:"Y-m-d H:i" }}</td>
                            <td>{{ item.cod_procedimiento }}</td>
                            <td>{{ item.cod_diagnostico_principal }}</td>
                            <td>${{ item.vr_servicio|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No hay procedimientos RIPS.</p>
            {% endif %}

            {# Hospitalización #}
            {% if rips_hospitalizaciones %}
            <h6>Hospitalización</h6>
            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Consecutivo</th>
                            <th>F. Ingreso</th>
                            <th>F. Egreso</th>
                            <th>Diagnóstico Ppal.</th>
                            <th>Valor (Est.)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in rips_hospitalizaciones %}
                        <tr>
                            <td>{{ item.consecutivo }}</td>
                            <td>{{ item.fecha_inicio_atencion|date:"Y-m-d H:i" }}</td>
                            <td>{{ item.fecha_egreso|date:"Y-m-d H:i" }}</td>
                            <td>{{ item.cod_diagnostico_principal }}</td>
                            <td>${{ item.vr_servicio|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No hay hospitalizaciones RIPS.</p>
            {% endif %}

            {# Otros Servicios #}
            {% if rips_otros_servicios %}
            <h6>Otros Servicios</h6>
            <div class="table-responsive mb-3">
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Consecutivo</th>
                            <th>Fecha Suministro</th>
                            <th>Tipo OS</th>
                            <th>Cód. Tecnología</th>
                            <th>Nombre Tecnología</th>
                            <th>Cantidad</th>
                            <th>Valor Unit.</th>
                            <th>Valor Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in rips_otros_servicios %}
                        <tr>
                            <td>{{ item.consecutivo }}</td>
                            <td>{{ item.fecha_suministro|date:"Y-m-d H:i" }}</td>
                            <td>{{ item.tipo_os }}</td>
                            <td>{{ item.cod_tecnologia_salud }}</td>
                            <td>{{ item.nom_tecnologia_salud }}</td>
                            <td>{{ item.cantidad_os }}</td>
                            <td>${{ item.vr_unit_os|floatformat:2 }}</td>
                            <td>${{ item.vr_servicio|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No hay otros servicios RIPS.</p>
            {% endif %}

        </div>
    </div>
    
    <div class="mt-4 text-center no-print">
        <a href="{% url 'auditoria:auditar_factura' factura.pk %}" class="btn btn-secondary me-2"><i class="bi bi-arrow-left"></i> Volver a Auditoría</a>
        <a href="{% url 'auditoria:lista_radicados' %}" class="btn btn-info"><i class="bi bi-list-ul"></i> Ver todas las Facturas</a>
    </div>

</div>
{% endblock %} 