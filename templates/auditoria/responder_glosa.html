{% extends 'base.html' %}
{% block title %}Responder Glosa{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Responder a Glosa de la Factura <span class="badge bg-primary">{{ glosa.factura.numero }}</span></h2>
    <p><strong>Glosa ID:</strong> {{ glosa.id }}</p>
    <p><strong>Descripción de la Glosa:</strong> {{ glosa.descripcion }}</p>
    <p><strong>Valor Glosado:</strong> ${{ glosa.valor_glosado|floatformat:2 }}</p>

    <form method="post" enctype="multipart/form-data" class="mt-4">
        {% csrf_token %}
        <div class="mb-3">
            <label for="tipo_glosa_respuesta" class="form-label">Tipo de Respuesta</label>
            <select id="tipo_glosa_respuesta" name="tipo_glosa_respuesta" class="form-select" required>
                <option value="">Seleccione un tipo de respuesta</option>
                {% for tipo in tipos_respuesta %}
                    <option value="{{ tipo.pk }}">{{ tipo.codigo }} - {{ tipo.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="subtipo_glosa_respuesta" class="form-label">Subtipo de Respuesta</label>
            <select id="subtipo_glosa_respuesta" name="subtipo_glosa_respuesta" class="form-select" required>
                <option value="">Seleccione un subtipo</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="descripcion_respuesta" class="form-label">Descripción de la Respuesta</label>
            <textarea id="descripcion_respuesta" name="descripcion_respuesta" class="form-control" rows="4" required></textarea>
        </div>
        <div class="mb-3">
            <label for="archivo_soporte_respuesta" class="form-label">Adjuntar Soporte (Opcional)</label>
            <input type="file" id="archivo_soporte_respuesta" name="archivo_soporte_respuesta" class="form-control">
        </div>

        {% if user.profile.role == 'IPS' %}
        <div class="mb-3">
            <label for="decision_glosa" class="form-label">Decisión sobre la Glosa</label>
            <select id="decision_glosa" name="decision_glosa" class="form-select">
                <option value="">-- Mantener Sin Decisión --</option>
                <option value="true" {% if glosa.aceptada %}selected{% endif %}>Aceptada</option>
                <option value="false" {% if glosa.aceptada == False %}selected{% endif %}>Rechazada</option>
            </select>
        </div>
        
        <!-- Opción de valor parcial cuando rechaza -->
        <div class="mb-3" id="valor_parcial_ips_container" style="display: none;">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="pago_parcial_ips" name="pago_parcial_ips">
                <label class="form-check-label" for="pago_parcial_ips">
                    <strong>Proponer Valor Parcial</strong>
                </label>
            </div>
            <small class="form-text text-muted">Si rechaza la glosa, puede proponer un valor parcial para negociación.</small>
        </div>

        <div class="mb-3" id="valor_parcial_ips_input_container" style="display: none;">
            <label for="valor_parcial_ips" class="form-label">Valor Parcial Propuesto:</label>
            <input type="number" class="form-control" id="valor_parcial_ips" name="valor_parcial_ips" step="0.01" placeholder="Ej: 50000.00">
            <small class="form-text text-muted">Valor original glosado: ${{ glosa.valor_glosado|floatformat:2 }}</small>
        </div>
        {% endif %}

        <button type="submit" class="btn btn-success"><i class="bi bi-send"></i> Enviar Respuesta</button>
        <a href="{% url 'auditoria:glosas_pendientes' %}" class="btn btn-secondary ms-2"><i class="bi bi-x-circle"></i> Cancelar</a>
    </form>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoRespuestaSelect = document.getElementById('tipo_glosa_respuesta');
    const subtipoRespuestaSelect = document.getElementById('subtipo_glosa_respuesta');
    const decisionGlosaSelect = document.getElementById('decision_glosa');
    const valorParcialContainer = document.getElementById('valor_parcial_ips_container');
    const valorParcialInputContainer = document.getElementById('valor_parcial_ips_input_container');
    const pagoParcialCheckbox = document.getElementById('pago_parcial_ips');
    const valorParcialInput = document.getElementById('valor_parcial_ips');

    // Manejar cambio en tipo de respuesta
    tipoRespuestaSelect.addEventListener('change', function() {
        const tipoId = this.value;
        subtipoRespuestaSelect.innerHTML = '<option value="">Cargando...</option>';

        if (tipoId) {
            // Asumiendo que tienes un endpoint similar para los subtipos de respuesta
            fetch(`/auditoria/api/subtipos_respuesta/${tipoId}/`)
                .then(response => response.json())
                .then(data => {
                    subtipoRespuestaSelect.innerHTML = '<option value="">Seleccione un subtipo</option>';
                    data.forEach(subtipo => {
                        subtipoRespuestaSelect.innerHTML += `<option value="${subtipo.pk}">${subtipo.codigo_nombre}</option>`;
                    });
                });
        } else {
            subtipoRespuestaSelect.innerHTML = '<option value="">Seleccione un subtipo</option>';
        }
    });

    // Manejar cambio en decisión de glosa
    if (decisionGlosaSelect) {
        decisionGlosaSelect.addEventListener('change', function() {
            if (this.value === 'false') {
                // Si rechaza, mostrar opción de valor parcial
                valorParcialContainer.style.display = 'block';
            } else {
                // Si acepta o no decide, ocultar opción de valor parcial
                valorParcialContainer.style.display = 'none';
                valorParcialInputContainer.style.display = 'none';
                pagoParcialCheckbox.checked = false;
                valorParcialInput.value = '';
            }
        });
    }

    // Manejar checkbox de pago parcial
    if (pagoParcialCheckbox) {
        pagoParcialCheckbox.addEventListener('change', function() {
            if (this.checked) {
                valorParcialInputContainer.style.display = 'block';
                valorParcialInput.required = true;
            } else {
                valorParcialInputContainer.style.display = 'none';
                valorParcialInput.required = false;
                valorParcialInput.value = '';
            }
        });
    }
});
</script>
{% endblock %}
{% endblock %} 